#!/bin/bash
SCRIPTDIR="vendor/mediact/testing-suite/bin/"
VENDOR=$(composer config vendor-dir)
BIN=$(composer config bin-dir)

# Run unit tests.
cat $SCRIPTDIR/phpunitheader.txt
test ! -f phpunit.xml \
|| test ! -x $BIN/phpunit \
|| $BIN/phpunit \
  --fail-on-warning \
  --disallow-test-output \
  --report-useless-tests || exit $?

# Require the coding standards, if they are not explicitly defined.
test -d $VENDOR/mediact/coding-standard \
|| composer require mediact/coding-standard \
  --dev \
  --prefer-dist \
  --no-scripts \
  --ignore-platform-reqs \
  --no-progress \
  --optimize-autoloader \
  --no-interaction || exit $?

# Run static code analysis.
if [ -d src ]; then
  cat $SCRIPTDIR/phpcsheader.txt
  test -f phpcs.xml && $BIN/phpcs src || exit $?
  cat $SCRIPTDIR/phpmdheader.txt
  test -f phpmd.xml && $BIN/phpmd src xml phpmd.xml || exit $?
  cat $SCRIPTDIR/phpstanheader.txt
  $BIN/phpstan analyse src --level 4 --no-progress || exit $?
fi

if [ -d tests ]; then
  cat $SCRIPTDIR/phpcsheader.txt
  test -f phpcs.xml && $BIN/phpcs tests || exit $?
  cat $SCRIPTDIR/phpmdheader.txt
  test -f phpmd.xml && $BIN/phpmd tests xml phpmd.xml || exit $?
  cat $SCRIPTDIR/phpstanheader.txt
  $BIN/phpstan analyse tests --level 4 --no-progress || exit $?
fi
